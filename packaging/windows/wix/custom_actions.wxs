<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!--
    Custom actions to mimic the NSIS behavior defined in cmake/packaging/windows_nsis.cmake:
    - Reset ACLs on install dir
    - Update PATH (add/remove)
    - Migrate config files
    - Install firewall exceptions
    - Install/update SudoVDA virtual display driver
    - Install/uninstall Apollo service and autostart configuration
    - Optional prompts on uninstall for SudoVDA removal and deleting install dir

    Notes:
    - Relies on WixUtilExtension (WixQuietExec) to run commands quietly with logging.
    - Uses [INSTALL_ROOT] as the install directory property used by CPack WiX.
  -->

  <Fragment>
    <!-- Pull this fragment into the CPack-generated MSI -->
    <FeatureRef Id="ProductFeature"/>
    
    <!-- Keep Restart Manager enabled (default) to stop services in basic/silent UI -->
    
    <!-- Embedded VBScript to prompt the user on uninstall -->
    <Binary Id="AskRmSudovdaVbs" SourceFile="$(sys.SOURCEFILEDIR)ask_remove_sudovda.vbs"/>
    <Binary Id="AskDelInstDirVbs" SourceFile="$(sys.SOURCEFILEDIR)ask_delete_install_dir.vbs"/>
    <!-- VBScript to show a final repair-complete notification (full UI only) -->
    <Binary Id="RepairCompleteVbs" SourceFile="$(sys.SOURCEFILEDIR)repair_complete.vbs"/>
    <!-- VBScripts for existing Apollo handling -->
    <Binary Id="AskUninstallApolloVbs" SourceFile="$(sys.SOURCEFILEDIR)ask_uninstall_apollo.vbs"/>
    <Binary Id="WaitForApolloUninstallVbs" SourceFile="$(sys.SOURCEFILEDIR)wait_for_apollo_uninstall.vbs"/>
    <Binary Id="AskRmGamepadVbs" SourceFile="$(sys.SOURCEFILEDIR)ask_remove_gamepad.vbs"/>

  </Fragment>

  <!-- Define a stable tools directory under INSTALL_ROOT for WiX-authored payloads -->
  <Fragment>
    <DirectoryRef Id="INSTALL_ROOT">
      <Directory Id="DIR_Tools" Name="tools"/>
    </DirectoryRef>
  </Fragment>

  <!-- Control legacy service names separate from primary service component -->
  <Fragment>
    <DirectoryRef Id="INSTALL_ROOT">
      <Component Id="CtlStopApolloLegacy" Guid="{640D87CF-69A4-4F54-AE29-941F78D020B2}" KeyPath="yes">
        <CreateFolder/>
        <ServiceControl Id="SC_StopLegacyApollo" Name="sunshinesvc" Stop="both" Remove="uninstall" Wait="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALL_ROOT">
      <Component Id="SudoVdaRegistryDefaults" Guid="*" Win64="yes">
        <RegistryKey Root="HKLM" Key="SOFTWARE\SudoMaker\SudoVDA">
          <RegistryValue Id="RegSudoVdaSdrBits" Name="sdrBits" Type="integer" Value="10" KeyPath="yes"/>
          <RegistryValue Id="RegSudoVdaHdrBits" Name="hdrBits" Type="integer" Value="12"/>
        </RegistryKey>
      </Component>
    </DirectoryRef>
  </Fragment>

  <!-- Official service installation component (installed under INSTALL_ROOT\tools) -->
  <Fragment>
    <DirectoryRef Id="DIR_Tools">
      <Component Id="ApolloSvc" Guid="{CBA8A3D9-5A2A-4F76-9923-5B23D1EDFBB6}">
        <File Id="ApolloSvcExe" Source="!(bindpath.PayloadRoot)tools\\sunshinesvc.exe" KeyPath="yes" />
        <ServiceInstall
            Id="ApolloServiceInstall"
            Name="ApolloService"
            DisplayName="Apollo Service"
            Type="ownProcess"
            Start="auto"
            ErrorControl="normal"
            Arguments="--service" />
        <ServiceControl Id="StartApolloService"
            Name="ApolloService"
            Start="install"
            Stop="both"
            Remove="uninstall"
            Wait="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALL_ROOT">
      <Component Id="RemoveLegacyApolloUninstallKey" Guid="{6AE78F9A-37E3-44EB-AE6E-5ECFAC03A899}" KeyPath="yes" Win64="yes">
        <CreateFolder/>
        <RemoveRegistryKey Id="RemoveLegacyApolloUninstallKeyHKLM" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\Apollo" Action="removeOnInstall" />
        <RemoveRegistryKey Id="RemoveLegacyApolloUninstallKeyHKLM32" Root="HKLM" Key="Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\Apollo" Action="removeOnInstall" />
        <RemoveRegistryKey Id="RemoveLegacyApolloUninstallKeyHKLM_is1" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\Apollo_is1" Action="removeOnInstall" />
        <RemoveRegistryKey Id="RemoveLegacyApolloUninstallKeyHKLM32_is1" Root="HKLM" Key="Software\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\Apollo_is1" Action="removeOnInstall" />
        <RemoveRegistryKey Id="RemoveLegacyApolloUninstallKeyHKCU" Root="HKCU" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\Apollo" Action="removeOnInstall" />
        <RemoveRegistryKey Id="RemoveLegacyApolloUninstallKeyHKCU_is1" Root="HKCU" Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\Apollo_is1" Action="removeOnInstall" />
      </Component>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <CustomAction Id="ResetAcls" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="MigrateConfig" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="InstallSudovda" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <CustomAction Id="InstallGamepad" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <CustomAction Id="UpdatePathAdd" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="UpdatePathRemove" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />

    <!-- Prune stale web assets directory prior to installing new files (avoids stale hashed JS/CSS) -->
    <CustomAction Id="PruneWebDir" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />

    <!-- Uninstall-time actions (deferred, elevated) -->
    <CustomAction Id="RestoreNvPrefsUndo" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <!-- Quiet stop for repair/basic UI: proactively stop service when UI is too low for prompts -->
    <CustomAction Id="StopSvcQuietImmediate" BinaryKey="WixCA" DllEntry="WixQuietExec" Return="ignore" />
    <CustomAction Id="StopSvcQuiet" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <!-- Quiet start after repair for non-full UI; run at commit to avoid FilesInUse/reboot prompts -->
    <CustomAction Id="StartSvcQuiet" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="commit" Return="ignore" Impersonate="no" />
    <!-- Quiet process kill and service removal for manual uninstalls -->
    <CustomAction Id="KillProcsQuietImmediate" BinaryKey="WixCA" DllEntry="WixQuietExec" Return="ignore" />
    <CustomAction Id="KillProcsQuiet" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <CustomAction Id="RemoveServiceQuiet" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <CustomAction Id="UninstallSudovda" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <CustomAction Id="UninstallGamepad" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <CustomAction Id="DeleteInstallDir" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />
    <!-- Remove everything but config on manual uninstalls when user chooses to keep data -->
    <CustomAction Id="PruneButConfig" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />

    <!-- Immediate property setters to pass commands to deferred QuietExec actions -->
    <CustomAction Id="SetResetAcls"
                 Property="ResetAcls"
                 Value="&quot;[SystemFolder]icacls.exe&quot; &quot;[INSTALL_ROOT].&quot; /reset"/>

    <CustomAction Id="SetMigrateConfig"
                 Property="MigrateConfig"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;[INSTALL_ROOT]scripts\migrate-config.bat&quot;&quot;"/>

    <CustomAction Id="SetInstallSudovda"
                 Property="InstallSudovda"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoLogo -NonInteractive -NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File &quot;[INSTALL_ROOT]drivers\sudovda\install.ps1&quot;"/>

    <CustomAction Id="SetInstallGamepad"
                 Property="InstallGamepad"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -File &quot;[INSTALL_ROOT]scripts\install-gamepad.ps1&quot;"/>

    <CustomAction Id="SetUpdatePathAdd"
                 Property="UpdatePathAdd"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;[INSTALL_ROOT]scripts\update-path.bat&quot; add&quot;"/>

    <!-- Immediate setter for pruning installed web assets directory before file copy -->
    <CustomAction Id="SetPruneWebDir"
                 Property="PruneWebDir"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$p='[INSTALL_ROOT]assets\web'; if (Test-Path -LiteralPath $p) { Remove-Item -LiteralPath $p -Recurse -Force -ErrorAction SilentlyContinue }&quot;"/>


    <!-- Guard NV prefs restore on uninstall: only run if sunshine.exe still exists -->
    <CustomAction Id="SetRestoreNvPrefsUndo"
                 Property="RestoreNvPrefsUndo"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C if exist &quot;[INSTALL_ROOT]sunshine.exe&quot; ( &quot;[INSTALL_ROOT]sunshine.exe&quot; --restore-nvprefs-undo ) else ( exit /b 0 )"/>

    <CustomAction Id="AskRemoveSudovda" BinaryKey="AskRmSudovdaVbs" VBScriptCall="AskRemoveSudovda" Execute="immediate" Return="check" />
    <CustomAction Id="AskRemoveGamepad" BinaryKey="AskRmGamepadVbs" VBScriptCall="AskRemoveGamepad" Execute="immediate" Return="check" />
    <CustomAction Id="SetUninstallSudovda"
                 Property="UninstallSudovda"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;[INSTALL_ROOT]drivers\sudovda\uninstall.bat&quot;&quot;"/>
    <CustomAction Id="SetUninstallGamepad"
                 Property="UninstallGamepad"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -File &quot;[INSTALL_ROOT]scripts\uninstall-gamepad.ps1&quot;"/>

    <CustomAction Id="AskDeleteInstallDir" BinaryKey="AskDelInstDirVbs" VBScriptCall="AskDeleteInstallDir" Execute="immediate" Return="check" />
    <CustomAction Id="SetDeleteInstallDir"
                 Property="DeleteInstallDir"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C rmdir /S /Q &quot;[INSTALL_ROOT].&quot;"/>
    <!-- Immediate setter for quiet stop service -->
    <CustomAction Id="SetStopSvcQuietImmediate"
                 Property="StopSvcQuietImmediate"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -Command &quot;&amp; { $svc = Get-Service -Name 'SunshineService' -ErrorAction SilentlyContinue; if ($svc) { if ($svc.Status -ne 'Stopped') { Stop-Service -Name 'SunshineService' -Force -ErrorAction SilentlyContinue; $svc.WaitForStatus('Stopped','00:00:30') } } }&quot;"/>
    <CustomAction Id="SetStopSvcQuiet"
                 Property="StopSvcQuiet"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -Command &quot;&amp; { $names=@('ApolloService','SunshineService','sunshinesvc'); foreach($n in $names){ $svc=Get-Service -Name $n -ErrorAction SilentlyContinue; if($svc){ if($svc.Status -ne 'Stopped'){ Stop-Service -Name $n -Force -ErrorAction SilentlyContinue; $svc.WaitForStatus('Stopped','00:00:30') } } } }&quot;"/>
    <!-- Immediate setter to prune everything except the config directory -->
    <CustomAction Id="SetPruneButConfig"
                 Property="PruneButConfig"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$r='[INSTALL_ROOT]'; Get-ChildItem -LiteralPath $r -Force | Where-Object Name -ne 'config' | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue&quot;"/>

    <!-- Immediate setter for quiet start service -->
    <CustomAction Id="SetStartSvcQuiet"
                 Property="StartSvcQuiet"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -Command &quot;&amp; { $svc = Get-Service -Name 'ApolloService' -ErrorAction SilentlyContinue; if(-not $svc){ $svc = Get-Service -Name 'SunshineService' -ErrorAction SilentlyContinue } if($svc -and $svc.Status -ne 'Running'){ Start-Service -Name $svc.Name -ErrorAction SilentlyContinue; $svc.WaitForStatus('Running','00:00:20') } }&quot;"/>
    <!-- Immediate setters for quiet process kill and service removal on manual uninstall -->
    <CustomAction Id="SetKillProcsQuietImmediate"
                 Property="KillProcsQuietImmediate"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$n='sunshine','sunshinesvc','sunshine_wgc_capture','playnite_launcher'; foreach($p in $n){ Get-Process -Name $p -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue }&quot;"/>
    <CustomAction Id="SetKillProcsQuiet"
                 Property="KillProcsQuiet"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;$n='sunshine','sunshinesvc','sunshine_wgc_capture','playnite_launcher','apollo','apollosvc'; foreach($p in $n){ Get-Process -Name $p -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue }&quot;"/>

    <CustomAction Id="SetUpdatePathRemove"
                 Property="UpdatePathRemove"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;[INSTALL_ROOT]scripts\update-path.bat&quot; remove&quot;"/>

    <CustomAction Id="SetRemoveServiceQuiet"
                 Property="RemoveServiceQuiet"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -Command &quot;&amp; { sc.exe delete 'ApolloService' | Out-Null; sc.exe delete 'SunshineService' | Out-Null; sc.exe delete 'sunshinesvc' | Out-Null }&quot;"/>

    <!-- Existing Apollo handling actions -->
    <CustomAction Id="AskUninstallApollo" BinaryKey="AskUninstallApolloVbs" VBScriptCall="AskUninstallApollo" Execute="immediate" Return="check" />
    <CustomAction Id="WaitForApolloUninstall" BinaryKey="WaitForApolloUninstallVbs" VBScriptCall="WaitForApolloUninstall" Execute="immediate" Return="check" />
    
    <CustomAction Id="BlockApolloStillPresent" Error="An existing Apollo installation is still detected. It must be removed before installing Vibeshine; click OK to start the uninstallation." />
    <CustomAction Id="BlockUserCancelledApollo" Error="Installation cancelled. Apollo must be removed before installing Vibeshine." />

    <!-- UI-only prompt at end of a successful Repair to inform no reboot is required -->
    <CustomAction Id="RepairCompletePrompt" BinaryKey="RepairCompleteVbs" VBScriptCall="ShowRepairComplete" Execute="immediate" Return="ignore" />

  </Fragment>

  <!-- PATH management handled via scripted custom actions -->

  <Fragment>
    <DirectoryRef Id="INSTALL_ROOT">
      <Component Id="Fw_Exceptions" Guid="{7229349C-BC66-4A1D-8019-9546CBD2620B}">
        <CreateFolder/>
        <Firewall:FirewallException xmlns:Firewall="http://schemas.microsoft.com/wix/FirewallExtension"
                                    Id="FE_ApolloExe"
                                    Name="Vibepollo"
                                    Program="[INSTALL_ROOT]sunshine.exe"
                                    Profile="all"
                                    Scope="any" />
        <Firewall:FirewallException xmlns:Firewall="http://schemas.microsoft.com/wix/FirewallExtension"
                                    Id="FE_ApolloSvcExe"
                                    Name="Vibepollo Service"
                                    Program="[INSTALL_ROOT]tools\sunshinesvc.exe"
                                    Profile="all"
                                    Scope="any" />
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
