<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!--
    Custom actions to mimic the NSIS behavior defined in cmake/packaging/windows_nsis.cmake:
    - Reset ACLs on install dir
    - Update PATH (add/remove)
    - Migrate config files
    - Add/remove firewall rules
    - Install/uninstall Virtual Gamepad (ViGEm) via PowerShell helper
    - Install/uninstall Sunshine service and autostart configuration
    - Optional prompts on uninstall for gamepad removal and deleting install dir

    Notes:
    - Relies on WixUtilExtension (WixQuietExec) to run commands quietly with logging.
    - Uses [INSTALL_ROOT] as the install directory property used by CPack WiX.
  -->

  <Fragment>
    <!-- Embedded VBScript to prompt the user on uninstall -->
    <Binary Id="AskRemoveGamepadVbs" SourceFile="$(sys.SOURCEFILEDIR)ask_remove_gamepad.vbs"/>
    <Binary Id="AskDeleteInstallDirVbs" SourceFile="$(sys.SOURCEFILEDIR)ask_delete_install_dir.vbs"/>
    <!-- WiX standard custom action library providing WixQuietExec -->
    <Binary Id="WixCA" SourceFile="$(env.WIX)\bin\WixCA.dll"/>

    <!-- Install-time actions (deferred, elevated) -->
    <CustomAction Id="ResetAcls" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="UpdatePathAdd" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="MigrateConfig" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="AddFirewallRule" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="InstallGamepad" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="InstallService" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="AutostartService" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />

    <!-- Uninstall-time actions (deferred, elevated) -->
    <CustomAction Id="DeleteFirewallRule" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="UninstallService" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="RestoreNvPrefsUndo" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="UninstallGamepad" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="UpdatePathRemove" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="check" Impersonate="no" />
    <CustomAction Id="DeleteInstallDir" BinaryKey="WixCA" DllEntry="WixQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />

    <!-- Immediate property setters to pass commands to deferred QuietExec actions -->
    <CustomAction Id="SetResetAcls"
                 Property="ResetAcls"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C icacls &quot;[INSTALL_ROOT]&quot; /reset"/>

    <CustomAction Id="SetUpdatePathAdd"
                 Property="UpdatePathAdd"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\update-path.bat&quot;&quot; add&quot;"/>

    <CustomAction Id="SetMigrateConfig"
                 Property="MigrateConfig"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\migrate-config.bat&quot;&quot;&quot;"/>

    <CustomAction Id="SetAddFirewallRule"
                 Property="AddFirewallRule"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\add-firewall-rule.bat&quot;&quot;&quot;"/>

    <CustomAction Id="SetInstallGamepad"
                 Property="InstallGamepad"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -File &quot;&quot;&quot;[INSTALL_ROOT]scripts\install-gamepad.ps1&quot;&quot;&quot;"/>

    <CustomAction Id="SetInstallService"
                 Property="InstallService"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\install-service.bat&quot;&quot;&quot;"/>

    <CustomAction Id="SetAutostartService"
                 Property="AutostartService"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\autostart-service.bat&quot;&quot;&quot;"/>

    <CustomAction Id="SetDeleteFirewallRule"
                 Property="DeleteFirewallRule"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\delete-firewall-rule.bat&quot;&quot;&quot;"/>

    <CustomAction Id="SetUninstallService"
                 Property="UninstallService"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\uninstall-service.bat&quot;&quot;&quot;"/>

    <CustomAction Id="SetRestoreNvPrefsUndo"
                 Property="RestoreNvPrefsUndo"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]sunshine.exe&quot;&quot; --restore-nvprefs-undo&quot;"/>

    <CustomAction Id="AskRemoveGamepad" BinaryKey="AskRemoveGamepadVbs" VBScriptCall="AskRemoveGamepad" Execute="immediate" Return="check" />
    <CustomAction Id="SetUninstallGamepad"
                 Property="UninstallGamepad"
                 Value="&quot;[SystemFolder]WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass -File &quot;&quot;&quot;[INSTALL_ROOT]scripts\uninstall-gamepad.ps1&quot;&quot;&quot;"/>

    <CustomAction Id="AskDeleteInstallDir" BinaryKey="AskDeleteInstallDirVbs" VBScriptCall="AskDeleteInstallDir" Execute="immediate" Return="check" />
    <CustomAction Id="SetUpdatePathRemove"
                 Property="UpdatePathRemove"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C &quot;&quot;&quot;[INSTALL_ROOT]scripts\update-path.bat&quot;&quot; remove&quot;"/>

    <CustomAction Id="SetDeleteInstallDir"
                 Property="DeleteInstallDir"
                 Value="&quot;[SystemFolder]cmd.exe&quot; /C rmdir /S /Q &quot;[INSTALL_ROOT]&quot;"/>

    <!-- Schedule actions -->
    <InstallExecuteSequence>
      <!-- Install: after files are laid down -->
      <Custom Action="SetResetAcls" After="InstallFiles">NOT REMOVE</Custom>
      <Custom Action="ResetAcls" After="SetResetAcls">NOT REMOVE</Custom>

      <Custom Action="SetUpdatePathAdd" After="ResetAcls">NOT REMOVE</Custom>
      <Custom Action="UpdatePathAdd" After="SetUpdatePathAdd">NOT REMOVE</Custom>

      <Custom Action="SetMigrateConfig" After="UpdatePathAdd">NOT REMOVE</Custom>
      <Custom Action="MigrateConfig" After="SetMigrateConfig">NOT REMOVE</Custom>

      <Custom Action="SetAddFirewallRule" After="MigrateConfig">NOT REMOVE</Custom>
      <Custom Action="AddFirewallRule" After="SetAddFirewallRule">NOT REMOVE</Custom>

      <Custom Action="SetInstallGamepad" After="AddFirewallRule">NOT REMOVE</Custom>
      <Custom Action="InstallGamepad" After="SetInstallGamepad">NOT REMOVE</Custom>

      <Custom Action="SetInstallService" After="InstallGamepad">NOT REMOVE</Custom>
      <Custom Action="InstallService" After="SetInstallService">NOT REMOVE</Custom>

      <Custom Action="SetAutostartService" After="InstallService">NOT REMOVE</Custom>
      <Custom Action="AutostartService" After="SetAutostartService">NOT REMOVE</Custom>

      <!-- Uninstall: before files are removed or at end depending on action -->
      <Custom Action="SetDeleteFirewallRule" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="DeleteFirewallRule" After="SetDeleteFirewallRule">REMOVE="ALL"</Custom>

      <Custom Action="SetUninstallService" After="DeleteFirewallRule">REMOVE="ALL"</Custom>
      <Custom Action="UninstallService" After="SetUninstallService">REMOVE="ALL"</Custom>

      <Custom Action="SetRestoreNvPrefsUndo" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="RestoreNvPrefsUndo" After="SetRestoreNvPrefsUndo">REMOVE="ALL"</Custom>

      <Custom Action="AskRemoveGamepad" After="RestoreNvPrefsUndo">REMOVE="ALL"</Custom>
      <Custom Action="SetUninstallGamepad" After="AskRemoveGamepad">REMOVE="ALL" AND REMOVEGAMEPAD = "1"</Custom>
      <Custom Action="UninstallGamepad" After="SetUninstallGamepad">REMOVE="ALL" AND REMOVEGAMEPAD = "1"</Custom>

      <Custom Action="SetUpdatePathRemove" After="UninstallGamepad">REMOVE="ALL"</Custom>
      <Custom Action="UpdatePathRemove" After="SetUpdatePathRemove">REMOVE="ALL"</Custom>

      <Custom Action="AskDeleteInstallDir" After="UpdatePathRemove">REMOVE="ALL"</Custom>
      <!-- Run delete after files are removed -->
      <Custom Action="SetDeleteInstallDir" After="RemoveFiles">REMOVE="ALL" AND DELETEINSTALLDIR = "1"</Custom>
      <Custom Action="DeleteInstallDir" After="SetDeleteInstallDir">REMOVE="ALL" AND DELETEINSTALLDIR = "1"</Custom>
    </InstallExecuteSequence>
  </Fragment>
</Wix>
